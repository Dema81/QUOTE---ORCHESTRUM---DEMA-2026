<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEMA Solutions - Quote System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel Standalone per compilare React/TSX nel browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Loading Spinner */
        #root:empty::before {
            content: "Caricamento Sistema...";
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #64748b;
            font-size: 0.875rem;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Error Display */
        #error-display {
            display: none;
            padding: 2rem;
            margin: 2rem auto;
            max-width: 600px;
            background: #fef2f2;
            border: 1px solid #ef4444;
            border-radius: 0.5rem;
            color: #991b1b;
            font-family: monospace;
            text-align: left;
            white-space: pre-wrap;
        }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>
    <div id="error-display"></div>
    
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { Mail, Send, ThumbsUp, Globe, ChevronRight, Eye, Copy, Check, AlertCircle } from 'lucide-react';

        // --- GESTIONE ERRORI GLOBALE ---
        window.onerror = function(message, source, lineno, colno, error) {
            const errorDiv = document.getElementById('error-display');
            const rootDiv = document.getElementById('root');
            if (errorDiv && rootDiv) {
                rootDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.innerHTML = `<strong>Errore Critico:</strong>\n${message}\n\nFile: ${source}:${lineno}`;
                console.error(error);
            }
        };

        // --- TIPI E DATI ---
        const Language = {
          ENGLISH: 'ENGLISH',
          ITALIAN: 'ITALIAN',
          SPANISH: 'SPANISH',
          CATALAN: 'CATALAN',
          GERMAN: 'GERMAN',
          FRENCH: 'FRENCH'
        };

        const FLAGS = {
          [Language.ENGLISH]: 'https://flagcdn.com/w80/gb.png',
          [Language.ITALIAN]: 'https://flagcdn.com/w80/it.png',
          [Language.SPANISH]: 'https://flagcdn.com/w80/es.png',
          [Language.CATALAN]: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/ce/Flag_of_Catalonia.svg/120px-Flag_of_Catalonia.svg.png',
          [Language.GERMAN]: 'https://flagcdn.com/w80/de.png',
          [Language.FRENCH]: 'https://flagcdn.com/w80/fr.png'
        };

        const SIGNATURES = [
          { id: 'aleksandra', name: 'Aleksandra Labudovic', role: 'Sales Manager' },
          { id: 'alessia', name: 'Alessia Santoro', role: 'Sales Manager' },
          { id: 'chiara', name: 'Chiara Tommasini', role: 'Sales Manager' },
          { id: 'gaetano', name: 'Gaetano Gambuto', role: 'Sales Manager' },
          { id: 'luka', name: 'Luka Pavlovic', role: 'Sales Manager' },
          { 
            id: 'maria', 
            name: 'Mar√≠a C√©spedes', 
            role: 'Sales Manager',
            company: 'Link Multiling√ºe, SL',
            phone: '+34 972 221 721',
            website: 'www.linkmultilingue.com'
          },
        ];

        const LOGO_URL = "https://raw.githubusercontent.com/dema81/QUOTE---ORCHESTRUM---DEMA-2026/main/logo_2.png";

        const TRANSLATIONS = {
          [Language.ENGLISH]: {
            subjectPrefix: 'QUOTE', salutation: 'Dear', intro: 'please find attached the requested quotation.',
            delivery: 'Delivery time: {days} working days from your order confirmation.',
            decision: 'You can communicate your decision through the following link:',
            feedback: 'Your feedback, even in case of rejection, is very important to us in order to constantly analyze and improve the quality of our proposals.',
            questions: "If you have any questions, please don't hesitate to contact us.",
            wishing: "Wishing you a good day and looking forward to hearing from you.",
            kindRegards: 'Kind regards,', btnAccept: 'Accept quote', btnReject: 'Reject quote', btnSendResponse: 'Send Response',
            sentTitle: 'Success!', sentBody: 'Your response has been prepared.',
            labelQuoteId: 'Quote ID', labelSubject: 'Subject', labelAmount: 'Amount',
            linkText: 'ACCEPT OR REJECT THE QUOTE',
            reasonTitle: 'Please select a reason for rejection:',
            reasonTime: 'Delivery time too long',
            reasonPrice: 'Price slightly higher than another provider',
            reasonBudget: 'Amount out of budget'
          },
          [Language.ITALIAN]: {
            subjectPrefix: 'PREVENTIVO', salutation: 'Gentile', intro: 'in allegato trovi il preventivo richiesto.',
            delivery: 'Tempi di consegna: {days} giorni lavorativi dalla conferma.',
            decision: 'Puoi comunicare la tua decisione tramite il seguente link:',
            feedback: 'Il tuo feedback, anche in caso di rifiuto, √® molto importante per noi per analizzare e migliorare costantemente la qualit√† delle nostre proposte.',
            questions: "Per qualsiasi domanda, non esitare a contattarci.",
            wishing: "Ti auguriamo una buona giornata e restiamo in attesa di un tuo riscontro.",
            kindRegards: 'Cordiali saluti,', btnAccept: 'Accetta preventivo', btnReject: 'Rifiuta preventivo', btnSendResponse: 'Invia Risposta',
            sentTitle: 'Inviato!', sentBody: 'La tua risposta √® stata preparata.',
            labelQuoteId: 'ID Preventivo', labelSubject: 'Oggetto', labelAmount: 'Importo',
            linkText: 'ACCETTA o RIFIUTA IL PREVENTIVO',
            reasonTitle: 'Seleziona il motivo del rifiuto:',
            reasonTime: 'Tempi troppo lunghi',
            reasonPrice: 'Prezzo poco pi√π alto di un altro fornitore',
            reasonBudget: 'Importo fuori budget'
          },
          [Language.SPANISH]: {
            subjectPrefix: 'PRESUPUESTO', salutation: 'Estimado/a', intro: 'adjunto encontrar√° el presupuesto solicitado.',
            delivery: 'Plazo de entrega: {days} d√≠as laborables desde la confirmaci√≥n.',
            decision: 'Puede comunicar su decisi√≥n a trav√©s del siguiente enlace:',
            feedback: 'Su opini√≥n, incluso en caso de rechazo, es muy importante para nosotros para analizar y mejorar constantemente la calidad de nuestras propuestas.',
            questions: "Si tiene alguna pregunta, no dude en contactarnos.",
            wishing: "Le deseamos un buen d√≠a y esperamos tener noticias suyas.",
            kindRegards: 'Saludos cordiales,', btnAccept: 'Aceptar', btnReject: 'Rechazar', btnSendResponse: 'Enviar Respuesta',
            sentTitle: '¬°Enviado!', sentBody: 'Su respuesta ha sido preparada.',
            labelQuoteId: 'ID Presupuesto', labelSubject: 'Asunto', labelAmount: 'Importe',
            linkText: 'ACEPTAR o RECHAZAR EL PRESUPUESTO',
            reasonTitle: 'Seleccione el motivo del rechazo:',
            reasonTime: 'Plazo de entrega demasiado largo',
            reasonPrice: 'Precio un poco m√°s alto que otro proveedor',
            reasonBudget: 'Importe fuera de presupuesto'
          },
          [Language.FRENCH]: {
            subjectPrefix: 'DEVIS', salutation: 'Cher/Ch√®re', intro: 'veuillez trouver ci-joint le devis demand√©.',
            delivery: 'D√©lai de livraison : {days} jours ouvrables √† compter de la confirmation.',
            decision: 'Vous pouvez communiquer votre d√©cision via le lien suivant :',
            feedback: 'Votre avis, m√™me en cas de refus, est tr√®s important pour nous afin d\'analyser et d\'am√©liorer constamment la qualit√© de nos propositions.',
            questions: "Si vous avez des questions, n'h√©sitez pas √† nous contacter.",
            wishing: "Nous vous souhaitons une bonne journ√©e dans l'attente de vos nouvelles.",
            kindRegards: 'Cordialement,', btnAccept: 'Accepter', btnReject: 'Refuser', btnSendResponse: 'Envoyer la r√©ponse',
            sentTitle: 'Envoy√© !', sentBody: 'Votre r√©ponse a √©t√© pr√©par√©e.',
            labelQuoteId: 'ID Devis', labelSubject: 'Objet', labelAmount: 'Montant',
            linkText: 'ACCEPTER ou REFUSER LE DEVIS',
            reasonTitle: 'Veuillez s√©lectionner un motif de refus :',
            reasonTime: 'D√©lai de livraison trop long',
            reasonPrice: 'Prix l√©g√®rement sup√©rieur √† un autre fournisseur',
            reasonBudget: 'Montant hors budget'
          },
          [Language.GERMAN]: {
            subjectPrefix: 'ANGEBOT', salutation: 'Sehr geehrte(r)', intro: 'anbei finden Sie das angeforderte Angebot.',
            delivery: 'Lieferzeit: {days} Werktage ab Auftragsbest√§tigung.',
            decision: 'Sie k√∂nnen Ihre Entscheidung √ºber den folgenden Link mitteilen:',
            feedback: 'Ihr Feedback, auch im Falle einer Ablehnung, ist uns sehr wichtig, um die Qualit√§t unserer Angebote st√§ndig zu analysieren und zu verbessern.',
            questions: "Bei Fragen z√∂gern Sie bitte nicht, uns zu kontaktieren.",
            wishing: "Wir w√ºnschen Ihnen einen sch√∂nen Tag und freuen uns darauf, von Ihnen zu h√∂ren.",
            kindRegards: 'Mit freundlichen Gr√º√üen,', btnAccept: 'Akzeptieren', btnReject: 'Ablehnen', btnSendResponse: 'Antwort senden',
            sentTitle: 'Gesendet!', sentBody: 'Ihre Antwort wurde vorbereitet.',
            labelQuoteId: 'Angebots-ID', labelSubject: 'Betreff', labelAmount: 'Betrag',
            linkText: 'ANGEBOT AKZEPTIEREN oder ABLEHNEN',
            reasonTitle: 'Bitte w√§hlen Sie einen Grund f√ºr die Ablehnung:',
            reasonTime: 'Lieferzeit zu lang',
            reasonPrice: 'Preis etwas h√∂her als bei einem anderen Anbieter',
            reasonBudget: 'Betrag au√üerhalb des Budgets'
          },
          [Language.CATALAN]: {
            subjectPrefix: 'PRESSUPOST', salutation: 'Benvolgut/da', intro: 'adjunt trobar√† el pressupost sol¬∑licitat.',
            delivery: 'Termini de lliurament: {days} dies feiners des de la confirmaci√≥.',
            decision: 'Pot comunicar la seva decisi√≥ a trav√©s del seg√ºent enlla√ß:',
            feedback: 'La seva opini√≥, fins i tot en cas de rebuig, √©s molt important per a nosaltres per analitzar i millorar constantment la qualitat de les nostres propostes.',
            questions: "Si t√© alguna pregunta, no dubti en contactar-nos.",
            wishing: "Li desitgem un bon dia i esperem tenir not√≠cies seves.",
            kindRegards: 'Salutacions cordials,', btnAccept: 'Acceptar', btnReject: 'Rebutjar', btnSendResponse: 'Enviar Resposta',
            sentTitle: 'Enviat!', sentBody: 'La seva resposta ha estat preparada.',
            labelQuoteId: 'ID Pressupost', labelSubject: 'Assumpte', labelAmount: 'Import',
            linkText: 'ACCEPTAR o REBUTJAR EL PRESSUPOST',
            reasonTitle: 'Seleccioneu el motiu del rebuig:',
            reasonTime: 'Termini de lliurament massa llarg',
            reasonPrice: 'Preu una mica m√©s alt que un altre prove√Ødor',
            reasonBudget: 'Import fora de pressupost'
          }
        };

        // --- APP COMPONENT ---
        const App = () => {
          const [view, setView] = useState('generator');
          const [step, setStep] = useState(1);
          const [sent, setSent] = useState(false);
          const [decision, setDecision] = useState(null); // 'accept' or 'reject'
          const [rejectionReason, setRejectionReason] = useState('');
          const [copied, setCopied] = useState(false);

          const [formData, setFormData] = useState({
            clientLanguage: Language.ENGLISH, 
            emailTo: '',
            emailCc: 'gr-quotes@dema-solutions.com',
            recipientName: '', 
            quoteId: new Date().getFullYear() + '/', 
            subject: '', 
            amount: '', 
            deliveryDays: '3-5', 
            signatureId: ''
          });

          useEffect(() => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('view') === 'decision') {
              setView('decision');
              setFormData(prev => ({
                ...prev,
                clientLanguage: params.get('lang') || Language.ENGLISH,
                quoteId: params.get('id') || '',
                subject: params.get('sub') || '',
                amount: params.get('amt') || '',
                emailTo: params.get('to') || 'gr-quotes@dema-solutions.com'
              }));
            }
          }, []);

          const t = TRANSLATIONS[formData.clientLanguage] || TRANSLATIONS[Language.ENGLISH];

          const linkUrl = useMemo(() => {
             const baseUrl = window.location.href.split('?')[0];
             return `${baseUrl}?view=decision&id=${encodeURIComponent(formData.quoteId)}&sub=${encodeURIComponent(formData.subject)}&amt=${encodeURIComponent(formData.amount)}&lang=${formData.clientLanguage}&to=${encodeURIComponent(formData.emailTo)}`;
          }, [formData]);

          // Testo semplice per mailto (senza HTML)
          const emailBodyPlain = useMemo(() => {
            const selectedSig = SIGNATURES.find(s => s.id === formData.signatureId);
            let sigText = '';

            if (selectedSig) {
                const company = selectedSig.company || 'DEMA SOLUTIONS S.R.L.';
                const phone = selectedSig.phone || '+39 039 9467 678';
                const website = selectedSig.website || 'www.dema-solutions.com';
                sigText = `\n\n${selectedSig.name}\n${selectedSig.role}\n${company}\n${phone}\n${website}`;
            }
            
            return `${t.salutation} ${formData.recipientName},\n${t.intro} (Ref: ${formData.quoteId})\n${t.delivery.replace('{days}', formData.deliveryDays)}\n${t.decision} ${t.linkText}\n${linkUrl}\n\n${t.feedback}\n\n${t.questions}\n${t.wishing}\n${t.kindRegards}${sigText}`;
          }, [formData, t, linkUrl]);

          // HTML per anteprima e copia incolla - REPLICATO FEDELMENTE SU APTOS 11PT
          const emailBodyHtml = useMemo(() => {
            const selectedSig = SIGNATURES.find(s => s.id === formData.signatureId);
            
            // Defaults (DEMA Standard)
            const company = selectedSig?.company || 'DEMA SOLUTIONS S.R.L.';
            const phone = selectedSig?.phone || '+39 039 9467 678';
            const website = selectedSig?.website || 'www.dema-solutions.com';
            const websiteUrl = website.startsWith('http') ? website : 'http://' + website;

            // Stili base per replicare Outlook/Aptos 11
            const baseStyle = "font-family: 'Aptos', 'Calibri', 'Verdana', sans-serif; font-size: 11pt; color: #000000; line-height: 1.3;";
            const linkStyle = "color: #0563C1; text-decoration: underline; font-weight: bold; text-transform: uppercase;";
            const grayItalicStyle = "color: #5A5A5A; font-style: italic;";
            
            return `
              <div style="${baseStyle}">
                <p style="margin: 0 0 11pt 0;">
                  ${t.salutation} ${formData.recipientName},<br>
                  ${t.intro} (Ref: ${formData.quoteId})<br>
                  ${t.delivery.replace('{days}', formData.deliveryDays)}<br>
                  ${t.decision} <a href="${linkUrl}" style="${linkStyle}">${t.linkText}</a>
                </p>
                
                <p style="margin: 0 0 11pt 0; ${grayItalicStyle}">
                  ${t.feedback}
                </p>
                
                <p style="margin: 0 0 11pt 0;">
                  ${t.questions}<br>
                  ${t.wishing}<br>
                  ${t.kindRegards}
                </p>
                
                ${selectedSig ? `
                  <div style="margin-top: 11pt;">
                    <strong>${selectedSig.name}</strong><br>
                    <span style="color: #5A5A5A;">${selectedSig.role}</span><br>
                    <strong><span style="color:#005a9c">${company}</span></strong><br>
                    <span style="display:inline-flex; align-items:center; gap: 4px;">üìû ${phone}</span><br>
                    <span style="display:inline-flex; align-items:center; gap: 4px;">üåê <a href="${websiteUrl}" style="color:#0563C1; text-decoration:underline;">${website}</a></span>
                  </div>
                ` : ''}
              </div>
            `;
          }, [formData, t, linkUrl]);

          const handleCreateMail = () => {
            const mailSubject = `${t.subjectPrefix}: ${formData.quoteId} - ${formData.subject}`;
            window.location.href = `mailto:${formData.emailTo}?cc=${formData.emailCc}&subject=${encodeURIComponent(mailSubject)}&body=${encodeURIComponent(emailBodyPlain)}`;
          };

          const handleCopyHtml = async () => {
             try {
                const blobHtml = new Blob([emailBodyHtml], { type: 'text/html' });
                const blobText = new Blob([emailBodyPlain], { type: 'text/plain' });
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'text/html': blobHtml,
                        'text/plain': blobText
                    })
                ]);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
             } catch (err) {
                 console.error('Failed to copy', err);
                 // Fallback per browser datati
                 const textarea = document.createElement('textarea');
                 textarea.value = emailBodyPlain;
                 document.body.appendChild(textarea);
                 textarea.select();
                 document.execCommand('copy');
                 document.body.removeChild(textarea);
                 setCopied(true);
                 setTimeout(() => setCopied(false), 2000);
             }
          };

          const handleSendResponse = () => {
            let body = "";
            let subject = "RE: " + t.subjectPrefix + ": " + formData.quoteId + " - " + formData.subject;

            if (decision === 'accept') {
                body = `I ACCEPT THE QUOTE ${formData.quoteId}\n\n`;
            } else {
                body = `I REJECT THE QUOTE ${formData.quoteId}\n\n`;
                if (rejectionReason) {
                    body += `Reason: ${rejectionReason}\n\n`;
                }
            }

            // Dati mantenuti, rimosso header "Details:" e linea tratteggiata
            body += `Quote ID: ${formData.quoteId}\n`;
            body += `Subject: ${formData.subject}\n`;
            body += `Amount: ${formData.amount}\n`;

            window.location.href = `mailto:${formData.emailTo}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            setSent(true);
          };

          // VIEW: CLIENT DECISION
          if (view === 'decision') {
            return (
              <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50">
                <div className="bg-white p-12 rounded-[2.5rem] shadow-2xl max-w-2xl w-full text-center border border-slate-200">
                  <img src={LOGO_URL} alt="DEMA" className="h-14 mx-auto mb-10" onError={(e) => e.currentTarget.style.display = 'none'} />
                  {sent ? (
                    <div className="animate-in fade-in zoom-in duration-300">
                      <div className="bg-green-100 text-green-600 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-8"><ThumbsUp size={48} /></div>
                      <h2 className="text-4xl font-bold text-slate-800 mb-4">{t.sentTitle}</h2>
                      <p className="text-xl text-slate-500">{t.sentBody}</p>
                    </div>
                  ) : (
                    <>
                      <div className="bg-slate-50 p-8 rounded-3xl text-left mb-10 text-lg border border-slate-100 shadow-sm">
                        <p className="mb-3"><strong className="text-slate-900">{t.labelQuoteId}:</strong> <span className="text-slate-600">{formData.quoteId}</span></p>
                        <p className="mb-3"><strong className="text-slate-900">{t.labelSubject}:</strong> <span className="text-slate-600">{formData.subject}</span></p>
                        <p><strong className="text-slate-900">{t.labelAmount}:</strong> <span className="text-slate-600">{formData.amount}</span></p>
                      </div>
                      
                      <div className="flex gap-6 mb-8">
                        <button onClick={() => { setDecision('accept'); setRejectionReason(''); }} className={`flex-1 py-6 text-lg rounded-2xl font-bold transition-all transform active:scale-95 ${decision === 'accept' ? 'bg-green-600 text-white shadow-lg shadow-green-200 ring-4 ring-green-600 ring-offset-2' : 'bg-white border-2 border-green-100 text-green-600 hover:bg-green-50'}`}>{t.btnAccept}</button>
                        <button onClick={() => { setDecision('reject'); }} className={`flex-1 py-6 text-lg rounded-2xl font-bold transition-all transform active:scale-95 ${decision === 'reject' ? 'bg-red-600 text-white shadow-lg shadow-red-200 ring-4 ring-red-600 ring-offset-2' : 'bg-white border-2 border-red-100 text-red-600 hover:bg-red-50'}`}>{t.btnReject}</button>
                      </div>

                      {/* AREA MOTIVI RIFIUTO */}
                      {decision === 'reject' && (
                          <div className="text-left bg-red-50 p-6 rounded-2xl mb-8 animate-in slide-in-from-top-2 border border-red-100">
                              <p className="font-semibold text-red-800 mb-4 text-lg">{t.reasonTitle}</p>
                              <div className="space-y-3">
                                  <label className="flex items-center gap-4 p-3 rounded-xl hover:bg-red-100 cursor-pointer transition-colors">
                                      <input type="radio" name="reason" value={t.reasonTime} onChange={(e) => setRejectionReason(e.target.value)} className="w-5 h-5 text-red-600 border-red-300 focus:ring-red-500" />
                                      <span className="text-lg text-red-700">{t.reasonTime}</span>
                                  </label>
                                  <label className="flex items-center gap-4 p-3 rounded-xl hover:bg-red-100 cursor-pointer transition-colors">
                                      <input type="radio" name="reason" value={t.reasonPrice} onChange={(e) => setRejectionReason(e.target.value)} className="w-5 h-5 text-red-600 border-red-300 focus:ring-red-500" />
                                      <span className="text-lg text-red-700">{t.reasonPrice}</span>
                                  </label>
                                  <label className="flex items-center gap-4 p-3 rounded-xl hover:bg-red-100 cursor-pointer transition-colors">
                                      <input type="radio" name="reason" value={t.reasonBudget} onChange={(e) => setRejectionReason(e.target.value)} className="w-5 h-5 text-red-600 border-red-300 focus:ring-red-500" />
                                      <span className="text-lg text-red-700">{t.reasonBudget}</span>
                                  </label>
                              </div>
                          </div>
                      )}

                      {/* PULSANTE INVIO */}
                      {(decision === 'accept' || (decision === 'reject' && rejectionReason)) && (
                        <button onClick={handleSendResponse} className="w-full bg-slate-900 text-white py-6 text-xl rounded-2xl font-bold flex items-center justify-center gap-3 hover:bg-slate-800 transition-all shadow-lg animate-in fade-in slide-in-from-bottom-4">
                          <Send size={24} /> {t.btnSendResponse}
                        </button>
                      )}
                    </>
                  )}
                </div>
              </div>
            );
          }

          // VIEW: GENERATOR
          return (
            <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50">
              <div className="bg-white p-10 rounded-[2rem] shadow-2xl max-w-3xl w-full border border-slate-100">
                <div className="relative flex items-center justify-center mb-10 pb-6 border-b border-slate-50">
                  <img src={LOGO_URL} alt="DEMA" className="h-10" onError={(e) => e.currentTarget.style.display = 'none'} />
                  <div className="absolute right-0 bg-slate-100 px-4 py-1.5 rounded-full text-[10px] font-bold text-slate-500 uppercase tracking-widest hidden sm:block">Quote Manager</div>
                </div>

                {step === 1 ? (
                  <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <h2 className="text-2xl font-bold text-slate-800 mb-8 flex items-center justify-center gap-3">
                      <div className="p-3 bg-blue-100 rounded-xl text-blue-600"><Globe size={28} /></div>
                      Choose client language:
                    </h2>
                    <div className="grid grid-cols-2 gap-6">
                      {Object.values(Language).map(lang => (
                        <button key={lang} onClick={() => { setFormData({...formData, clientLanguage: lang}); setStep(2); }} 
                          className="relative group p-8 rounded-2xl border-2 border-slate-100 bg-white hover:border-blue-500 hover:bg-blue-50 transition-all duration-300 flex items-center gap-6 text-left shadow-sm hover:shadow-xl transform hover:-translate-y-1">
                          
                          {/* FLAG */}
                          <img src={FLAGS[lang]} alt={lang} className="w-12 h-9 rounded-md object-cover shadow-sm group-hover:shadow-md transition-shadow" />
                          
                          <span className="text-xl font-bold text-slate-700 group-hover:text-blue-700">{lang}</span>
                          
                          <div className="absolute right-6 text-slate-300 group-hover:text-blue-500 transition-colors">
                             <ChevronRight size={24} />
                          </div>
                        </button>
                      ))}
                    </div>
                  </div>
                ) : (
                  <div className="space-y-6 animate-in slide-in-from-right duration-300">
                    <div className="grid grid-cols-2 gap-5">
                      <div className="col-span-2">
                        <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Recipient Name</label>
                        <input placeholder="e.g. Maria Rossi" value={formData.recipientName} onChange={e => setFormData({...formData, recipientName: e.target.value})} className="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 focus:border-blue-500 focus:ring-4 focus:ring-blue-50 outline-none transition-all font-medium text-slate-700" />
                      </div>
                      <div>
                        <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Quote ID</label>
                        <input value={formData.quoteId} onChange={e => setFormData({...formData, quoteId: e.target.value})} className="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 focus:border-blue-500 focus:ring-4 focus:ring-blue-50 outline-none transition-all font-medium text-slate-700" />
                      </div>
                      <div>
                        <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Amount</label>
                        <input placeholder="e.g. 1.500‚Ç¨" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} className="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 focus:border-blue-500 focus:ring-4 focus:ring-blue-50 outline-none transition-all font-medium text-slate-700" />
                      </div>
                      <div>
                        <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Delivery (Days)</label>
                        <input placeholder="3-5" value={formData.deliveryDays} onChange={e => setFormData({...formData, deliveryDays: e.target.value})} className="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 focus:border-blue-500 focus:ring-4 focus:ring-blue-50 outline-none transition-all font-medium text-slate-700" />
                      </div>
                      <div className="col-span-1">
                        <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Subject</label>
                        <input placeholder="Project details..." value={formData.subject} onChange={e => setFormData({...formData, subject: e.target.value})} className="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 focus:border-blue-500 focus:ring-4 focus:ring-blue-50 outline-none transition-all font-medium text-slate-700" />
                      </div>
                      <div className="col-span-2">
                        <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Signature</label>
                        <div className="relative">
                          <select value={formData.signatureId} onChange={e => setFormData({...formData, signatureId: e.target.value})} className="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 focus:border-blue-500 focus:ring-4 focus:ring-blue-50 outline-none transition-all font-medium text-slate-700 appearance-none cursor-pointer">
                            <option value="">Select your name...</option>
                            {SIGNATURES.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                          </select>
                          <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                            <ChevronRight size={16} className="rotate-90" />
                          </div>
                        </div>
                      </div>
                      <div>
                         <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Client Email</label>
                         <input placeholder="client@company.com" value={formData.emailTo} onChange={e => setFormData({...formData, emailTo: e.target.value})} className="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 focus:border-blue-500 focus:ring-4 focus:ring-blue-50 outline-none transition-all font-medium text-slate-700" />
                      </div>
                      <div>
                         <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">CC (Optional)</label>
                         <input placeholder="cc@company.com" value={formData.emailCc} onChange={e => setFormData({...formData, emailCc: e.target.value})} className="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 focus:border-blue-500 focus:ring-4 focus:ring-blue-50 outline-none transition-all font-medium text-slate-700" />
                      </div>
                    </div>
                    
                    {/* EMAIL PREVIEW SECTION */}
                    <div className="mt-8 bg-slate-50 rounded-xl p-5 border border-slate-200 shadow-sm">
                       <div className="flex justify-between items-center mb-4">
                           <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2"><Eye size={14} /> Email Preview</h3>
                           <button onClick={handleCopyHtml} className="text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                               {copied ? <Check size={14} /> : <Copy size={14} />} {copied ? 'Copied!' : 'Copy Text'}
                           </button>
                       </div>
                       <div className="font-sans text-sm text-slate-800 leading-relaxed bg-white p-6 rounded-lg border border-slate-100 shadow-inner" dangerouslySetInnerHTML={{ __html: emailBodyHtml }}></div>
                    </div>

                    <div className="flex gap-4 pt-4 mt-4 border-t border-slate-50">
                      <button onClick={() => setStep(1)} className="px-6 py-4 font-bold text-slate-400 hover:text-slate-600 transition-colors rounded-xl hover:bg-slate-50">Back</button>
                      <button onClick={handleCreateMail} className="flex-1 bg-blue-600 text-white py-4 px-8 rounded-xl font-bold shadow-lg shadow-blue-200 flex items-center justify-center gap-3 hover:bg-blue-700 transition-all transform active:scale-[0.98]">
                        <Mail size={20} /> Send Email
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        // --- RENDER ---
        try {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(<App />);
            }
        } catch (error) {
            console.error("Errore di rendering:", error);
        }
    </script>
</body>
</html>
